<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Category, Sub-Category & Product Management</title>
    <link rel="stylesheet" href="payment.css">
    <!-- <link rel="stylesheet" href="./sidebar.css"> -->
</head>

<body>
  <div id="sidebar-container"></div>

<div>
    <div class="form-container" >
        <!-- <h1>Payment Management</h1> -->
        
        <!-- View Payment Details Section -->
        <section class="form-section">
            <h2>Payment Details</h2>
            <table class="payment-table">
                <thead>
                    <tr>
                      <th>Payment ID</th>
                      <th>Order ID</th>
                      <th>Transaction ID</th>
                      <th>Amount</th>
                      <th>Payment Method</th>
                      <th>Payment Status</th>
                      <th>Payment Date</th>
                      <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="payment-list">
                    <!-- Example of a Payment Row -->
                    <!-- More payment records will go here -->
                </tbody>
            </table>
        </section>

        <!-- Search Payment Section -->
        <section class="form-section">
            <h2>Search Payment</h2>
            <form>
                <!-- Transaction ID Search -->
                <label for="search-transaction-id">Transaction ID:</label>
                <input type="text" id="search-transaction-id" name="search-transaction-id" placeholder="Enter Transaction ID" />

                <!-- Payment ID Search -->
                <label for="search-payment-id">Payment ID:</label>
                <input type="text" id="search-payment-id" name="search-payment-id" placeholder="Enter Payment ID" />

                <!-- Payment Status Search -->
                <label for="search-payment-status">Payment Status:</label>
                <select id="search-payment-status" name="search-payment-status">
                    <option value="">Select Status</option>
                    <option value="Completed">Completed</option>
                    <option value="Failed">Failed</option>
                    <option value="Pending">Pending</option>
                </select>

                <button type="submit">Search</button>
            </form>
        </section>
    </div>
</div>
<script src ="include.js"></script>
<script>
  const API_URL = 'http://127.0.0.1:1000';
document.addEventListener("DOMContentLoaded", function () {
    const paymentList = document.getElementById("payment-list");
    const form = document.querySelector("form");

    // Fetch and display all payments initially
    fetchPayments();

    // Listen for form submission (filter)
    form.addEventListener("submit", function (e) {
        e.preventDefault(); // Prevent page reload

        const transactionId = document.getElementById("search-transaction-id").value.trim().toLowerCase();
        const paymentId = document.getElementById("search-payment-id").value.trim();
        const paymentStatus = document.getElementById("search-payment-status").value.toLowerCase();

        fetchPayments(transactionId, paymentId, paymentStatus);
    });

    function fetchPayments(transactionId = "", paymentId = "", status = "") {
        fetch(`${API_URL}/payment_list`)
            .then(response => {
                if (!response.ok) {
                    throw new Error("Network response was not ok " + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                paymentList.innerHTML = ""; // Clear previous results

                const filteredPayments = data.filter(payment => {
                    const matchesTransactionId = !transactionId || payment.transaction_id.toLowerCase().includes(transactionId);
                    const matchesPaymentId = !paymentId || payment.payment_id.toString() === paymentId;
                    const matchesStatus = !status || payment.status.toLowerCase() === status;

                    return matchesTransactionId && matchesPaymentId && matchesStatus;
                });

                if (filteredPayments.length === 0) {
                    paymentList.innerHTML = `<tr><td colspan="9">No matching records found</td></tr>`;
                    return;
                }

                filteredPayments.forEach(payment => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${payment.payment_id}</td>
                        <td>${payment.order_id}</td>
                        <td>${payment.transaction_id}</td>
                        <td>â‚¹${payment.amount.toFixed(2)}</td>
                        <td>${payment.payment_method}</td>
                        <td>${payment.status}</td>
                        <td>${payment.payment_date || 'N/A'}</td>
                        <td style = "display: flex;gap: 7px;">
                            <button class="edit-btn" data-id="${payment.payment_id}">Edit</button>
                        </td>
                    `;
                    paymentList.appendChild(row);
                });

                attachButtonEvents();
            })
            .catch(error => {
                console.error("Error fetching payment data:", error);
            });
    }

    function attachButtonEvents() {
        // DELETE
        document.querySelectorAll(".delete-btn").forEach(button => {
            button.addEventListener("click", function () {
                const id = this.getAttribute("data-id");

                if (showConfirm("Are you sure you want to delete this payment?")) {
                    fetch(`${API_URL}/payment_list/${id}`, {
                        method: 'DELETE'
                    })
                    .then(res => res.json())
                    .then(response => {
                        showAlert(response.message || "Payment deleted");
                        fetchPayments();
                    })
                    .catch(err => console.error("Error deleting payment:", err));
                }
            });
        });

        // PUT (Update)
        document.querySelectorAll(".edit-btn").forEach(button => {
            button.addEventListener("click", function () {
                const id = this.getAttribute("data-id");
                showPrompt("Enter new status (Pending, Completed, Failed):", "", function(newStatus) {
                    if (newStatus) {
                        fetch(`${API_URL}/payment_list/${id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ status: newStatus })
                        })
                        .then(res => res.json())
                        .then(response => {
                            showAlert(response.message || "Payment updated");
                            fetchPayments();
                        })
                        .catch(err => console.error("Error updating payment:", err));
                    }
                });
            });
        });
    }
});

function showPrompt(message, defaultValue = "", onConfirm) {
    const promptOverlay = document.createElement("div");
    const promptBox = document.createElement("div");
    const promptMessage = document.createElement("p");
    const inputField = document.createElement("input");
    const promptButtons = document.createElement("div");
    const confirmButton = document.createElement("button");
    const cancelButton = document.createElement("button");

    // Overlay styles
    promptOverlay.style.position = "fixed";
    promptOverlay.style.top = 0;
    promptOverlay.style.left = 0;
    promptOverlay.style.width = "100%";
    promptOverlay.style.height = "100%";
    promptOverlay.style.backgroundColor = "rgba(0, 0, 0, 0.5)";
    promptOverlay.style.display = "flex";
    promptOverlay.style.alignItems = "center";
    promptOverlay.style.justifyContent = "center";
    promptOverlay.style.zIndex = 1000;

    // Prompt box styles
    promptBox.style.backgroundColor = "#fff";
    promptBox.style.padding = "20px";
    promptBox.style.borderRadius = "8px";
    promptBox.style.boxShadow = "0 4px 8px rgba(0, 0, 0, 0.2)";
    promptBox.style.textAlign = "center";
    promptBox.style.width = "400px"; // Default width for larger screens
    promptBox.style.maxWidth = "90%"; // Ensure it fits smaller screens

    // Prompt message styles
    promptMessage.textContent = message;
    promptMessage.style.marginBottom = "20px";
    promptMessage.style.fontSize = "1rem";

    // Input field styles
    inputField.type = "text";
    inputField.value = defaultValue;
    inputField.style.width = "100%";
    inputField.style.padding = "10px";
    inputField.style.marginBottom = "20px";
    inputField.style.border = "1px solid #ccc";
    inputField.style.borderRadius = "5px";
    inputField.style.fontSize = "1rem";

    // Prompt buttons container styles
    promptButtons.style.display = "flex";
    promptButtons.style.justifyContent = "space-between";
    promptButtons.style.gap = "10px";

    // Confirm button styles
    confirmButton.textContent = "OK";
    confirmButton.style.padding = "10px 20px";
    confirmButton.style.backgroundColor = "#007bff";
    confirmButton.style.color = "#fff";
    confirmButton.style.border = "none";
    confirmButton.style.borderRadius = "5px";
    confirmButton.style.cursor = "pointer";
    confirmButton.style.fontSize = "1rem";

    // Cancel button styles
    cancelButton.textContent = "Cancel";
    cancelButton.style.padding = "10px 20px";
    cancelButton.style.backgroundColor = "#dc3545";
    cancelButton.style.color = "#fff";
    cancelButton.style.border = "none";
    cancelButton.style.borderRadius = "5px";
    cancelButton.style.cursor = "pointer";
    cancelButton.style.fontSize = "1rem";

    // Adjust styles for smaller screens
    if (window.innerWidth <= 576) {
        promptBox.style.padding = "15px";
        promptMessage.style.fontSize = "0.9rem";
        inputField.style.fontSize = "0.9rem";
        confirmButton.style.padding = "8px 16px";
        confirmButton.style.fontSize = "0.9rem";
        cancelButton.style.padding = "8px 16px";
        cancelButton.style.fontSize = "0.9rem";
    }

    // Event listeners for buttons
    confirmButton.addEventListener("click", () => {
        const inputValue = inputField.value.trim();
        document.body.removeChild(promptOverlay);
        if (onConfirm) onConfirm(inputValue); // Call the confirmation callback with the input value
    });

    cancelButton.addEventListener("click", () => {
        document.body.removeChild(promptOverlay);
    });

    // Append elements
    promptButtons.appendChild(confirmButton);
    promptButtons.appendChild(cancelButton);
    promptBox.appendChild(promptMessage);
    promptBox.appendChild(inputField);
    promptBox.appendChild(promptButtons);
    promptOverlay.appendChild(promptBox);

    document.body.appendChild(promptOverlay);
}
</script>
</body>


</html>
``` 