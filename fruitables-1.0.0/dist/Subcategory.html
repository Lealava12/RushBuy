<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./category.css">
  <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css'>
  <link rel='stylesheet' href='https://unicons.iconscout.com/release/v3.0.6/css/line.css'>
  <link rel="stylesheet" href="./style.css">
</head>

<body>
  <div id="sidebar-container"></div>
  <div class="form-container">
    <h1>Sub-Category</h1>
    <section class="form-section">
      <h2>Sub-Category Management</h2>
      <form action="/save-subcategory" method="POST">
        <label for="sub-category-name">Sub-Category Name:</label>
        <input type="text" id="sub-category-name" name="sub-category-name" placeholder="Apple, Atta" required>

        <label for="parent-category">Parent Category:</label>
        <select id="parent-category" name="parent-category" required>
          <!-- Options will be dynamically populated -->
        </select>

        <label for="sub-category-description">Sub-Category Description:</label>
        <textarea id="sub-category-description" name="sub-category-description"
          placeholder="Brief description of the sub-category" rows="4"></textarea>

        <label for="sub-category-status">Sub-Category Status:</label>
        <select id="sub-category-status" name="sub-category-status">
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
        </select>

        <label for="sub-category-priority">Sub-Category Priority/Order:</label>
        <input type="number" id="sub-category-priority" name="sub-category-priority" placeholder="1" min="1">

        <button type="submit">Submit</button>
      </form>
    </section>

    <!-- Add a table to display subcategories -->
    <section class="form-section">
      <h2>Sub-Category List</h2>
      <table class="subcategory-table">
        <thead>
          <tr>
            <th>Sub-Category ID</th>
            <th>Name</th>
            <th>Description</th>
            <th>Parent Category</th>
            <th>Priority</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="subcategory-list">
          <!-- Subcategories will be dynamically populated here -->
        </tbody>
      </table>
    </section>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const apiBaseUrl = "http://127.0.0.1:1000"; // Backend URL
      const parentCategorySelect = document.getElementById("parent-category");
      const subCategoryForm = document.querySelector("form");
      const subCategoryList = document.getElementById("subcategory-list");

      // Fetch and populate parent categories in the dropdown
      async function fetchParentCategories() {
        try {
          const response = await fetch(`${apiBaseUrl}/get-categories`);
          const result = await response.json();

          if (response.ok) {
            parentCategorySelect.innerHTML = "<option value=''>Select a category</option>";
            result.categories.forEach((category) => {
              const option = document.createElement("option");
              option.value = category.category_id;
              option.textContent = category.name;
              parentCategorySelect.appendChild(option);
            });
          } else {
            alert(result.error || "Failed to fetch parent categories.");
          }
        } catch (error) {
          console.error("Error fetching parent categories:", error);
          alert("An error occurred while fetching parent categories.");
        }
      }

      // Fetch and display subcategories
      async function fetchSubCategories() {
        try {
          const response = await fetch(`${apiBaseUrl}/get-subcategories`);
          const result = await response.json();

          if (response.ok) {
            subCategoryList.innerHTML = ""; // Clear the list
            result.subcategories.forEach((subcategory) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${subcategory.subcategory_id}</td>
                <td>${subcategory.name}</td>
                <td>${subcategory.description}</td>
                <td>${subcategory.category_id}</td>
                <td>${subcategory.priority_order}</td>
                <td>${subcategory.status}</td>
                <td>
                  <button class="edit-btn" data-id="${subcategory.subcategory_id}">Edit</button>
                  <button class="delete-btn" data-id="${subcategory.subcategory_id}">Delete</button>
                </td>
              `;
              subCategoryList.appendChild(row);
            });
          } else {
            alert(result.error || "Failed to fetch subcategories.");
          }
        } catch (error) {
          console.error("Error fetching subcategories:", error);
          alert("An error occurred while fetching subcategories.");
        }
      }

      // Handle form submission (POST or PUT)
      subCategoryForm.addEventListener("submit", async (event) => {
        event.preventDefault(); // Prevent default form submission

        const subCategoryId = subCategoryForm.getAttribute("data-edit-id");
        const subCategoryName = document.getElementById("sub-category-name").value.trim();
        const parentCategory = parentCategorySelect.value;
        const subCategoryDescription = document.getElementById("sub-category-description").value.trim();
        const subCategoryStatus = document.getElementById("sub-category-status").value;
        const subCategoryPriority = document.getElementById("sub-category-priority").value;

        if (!subCategoryName || !parentCategory) {
          alert("Subcategory Name and Parent Category are required.");
          return;
        }

        try {
          const url = subCategoryId
            ? `${apiBaseUrl}/update-subcategory/${subCategoryId}` // PUT endpoint
            : `${apiBaseUrl}/save-subcategory`; // POST endpoint
          const method = subCategoryId ? "PUT" : "POST";

          const response = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              "sub-category-name": subCategoryName,
              "parent-category": parentCategory,
              "sub-category-description": subCategoryDescription,
              "sub-category-status": subCategoryStatus,
              "sub-category-priority": subCategoryPriority,
            }),
          });

          const result = await response.json();

          if (response.ok) {
            alert(result.message || "Subcategory saved successfully!");
            subCategoryForm.reset();
            subCategoryForm.removeAttribute("data-edit-id"); // Clear edit mode
            fetchSubCategories(); // Refresh the subcategory list
          } else {
            alert(result.error || "Failed to save subcategory. Please try again.");
          }
        } catch (error) {
          console.error("Error saving subcategory:", error);
          alert("An error occurred while saving the subcategory.");
        }
      });

      // Handle Edit and Delete button clicks
      subCategoryList.addEventListener("click", async (event) => {
        const target = event.target;
        const subCategoryId = target.getAttribute("data-id");

        if (target.classList.contains("edit-btn")) {
          // Edit subcategory
          try {
            const response = await fetch(`${apiBaseUrl}/get-subcategories`);
            const result = await response.json();

            if (response.ok) {
              const subcategory = result.subcategories.find((sub) => sub.subcategory_id === subCategoryId);
              if (subcategory) {
                document.getElementById("sub-category-name").value = subcategory.name;
                document.getElementById("parent-category").value = subcategory.category_id;
                document.getElementById("sub-category-description").value = subcategory.description;
                document.getElementById("sub-category-status").value = subcategory.status;
                document.getElementById("sub-category-priority").value = subcategory.priority_order;
                subCategoryForm.setAttribute("data-edit-id", subCategoryId); // Set edit mode
              } else {
                alert("Subcategory not found.");
              }
            } else {
              alert(result.error || "Failed to fetch subcategory details.");
            }
          } catch (error) {
            console.error("Error fetching subcategory details:", error);
            alert("An error occurred while fetching subcategory details.");
          }
        } else if (target.classList.contains("delete-btn")) {
          // Delete subcategory
          if (confirm("Are you sure you want to delete this subcategory?")) {
            try {
              const response = await fetch(`${apiBaseUrl}/delete-subcategory/${subCategoryId}`, {
                method: "DELETE",
              });

              const result = await response.json();

              if (response.ok) {
                alert(result.message || "Subcategory deleted successfully!");
                fetchSubCategories(); // Refresh the subcategory list
              } else {
                alert(result.error || "Failed to delete subcategory.");
              }
            } catch (error) {
              console.error("Error deleting subcategory:", error);
              alert("An error occurred while deleting the subcategory.");
            }
          }
        }
      });

      // Initial fetch of parent categories and subcategories
      await fetchParentCategories();
      await fetchSubCategories();
    });
  </script>
  <script src="include.js"></script>
</body>

</html>
